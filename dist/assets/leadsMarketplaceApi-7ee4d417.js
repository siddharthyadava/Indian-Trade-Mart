import{v as m,c as i}from"./index-d8c9f523.js";const E=e=>{if(!e)return 0;const t=new Date(e),a=Math.ceil((t-new Date)/(1e3*60*60*24));return Math.max(0,a)},v=e=>!e||e.status!=="ACTIVE"?!1:e.end_date?E(e.end_date)>0:!0,b=()=>{const e=new Date;return e.setHours(0,0,0,0),e},D=()=>{const e=new Date,t=e.getDay(),r=new Date(e),a=e.getDate()-t+(t===0?-6:1);return r.setDate(a),r.setHours(0,0,0,0),r},q=async(e,t)=>{if(!t)return null;const r=new Date(t.daily_reset_at||t.updated_at||t.created_at),a=new Date(t.weekly_reset_at||t.updated_at||t.created_at),s=b(),n=D();let d={...t},l=!1;if(r<s&&(d.daily_used=0,d.daily_reset_at=s.toISOString(),l=!0),a<n&&(d.weekly_used=0,d.weekly_reset_at=n.toISOString(),l=!0),l){const{error:o}=await i.from("vendor_lead_quota").update({daily_used:d.daily_used,weekly_used:d.weekly_used,daily_reset_at:d.daily_reset_at,weekly_reset_at:d.weekly_reset_at,updated_at:new Date().toISOString()}).eq("vendor_id",e);o&&console.error("Quota reset error:",o)}return d},A={getPreferences:async()=>{const e=await m.auth.me();if(!(e!=null&&e.id))throw new Error("Vendor not found");const{data:t,error:r}=await i.from("vendor_preferences").select("*").eq("vendor_id",e.id).single();if(r&&r.code!=="PGRST116")throw r;return t||null},savePreferences:async e=>{const t=await m.auth.me();if(!(t!=null&&t.id))throw new Error("Vendor not found");const{data:r}=await i.from("vendor_preferences").select("id").eq("vendor_id",t.id).maybeSingle(),a={vendor_id:t.id,preferred_micro_categories:e.preferred_micro_categories||[],preferred_states:e.preferred_states||[],preferred_cities:e.preferred_cities||[],min_budget:e.min_budget||0,max_budget:e.max_budget||999999,auto_lead_filter:e.auto_lead_filter!==!1,updated_at:new Date().toISOString()};let s;if(r){const{data:n,error:d}=await i.from("vendor_preferences").update(a).eq("vendor_id",t.id).select().single();if(d)throw d;s=n}else{a.created_at=new Date().toISOString();const{data:n,error:d}=await i.from("vendor_preferences").insert([a]).select().single();if(d)throw d;s=n}return s},getAvailableLeads:async(e={})=>{const t=await m.auth.me();if(!(t!=null&&t.id))throw new Error("Vendor not found");const r=await A.getPreferences();let{data:a}=await i.from("vendor_lead_quota").select("*").eq("vendor_id",t.id).maybeSingle();a&&(a=await q(t.id,a));const{data:s}=await i.from("vendor_plan_subscriptions").select("*").eq("vendor_id",t.id);let n=null;s&&s.length>0&&(n=s.find(p=>p.status==="ACTIVE"));let d=null;if(n&&n.plan_id){const{data:p}=await i.from("vendor_plans").select("*").eq("id",n.plan_id).maybeSingle();d={...n,plan:p}}else d=n;if(!v(d))return{data:[],quota:a,subscription:d,message:"No active subscription plan. Please subscribe to view leads."};const l=d==null?void 0:d.plan,o=(l==null?void 0:l.daily_limit)||0,_=(l==null?void 0:l.weekly_limit)||0,f=(l==null?void 0:l.yearly_limit)||0;if(a){if(o>0&&a.daily_used>=o)return{data:[],quota:a,subscription:d,message:"Daily lead limit reached"};if(_>0&&a.weekly_used>=_)return{data:[],quota:a,subscription:d,message:"Weekly lead limit reached"};if(f>0&&a.yearly_used>=f)return{data:[],quota:a,subscription:d,message:"Yearly lead limit reached"}}let u=i.from("leads").select(`
        id, title, product_name, budget, quantity, 
        location, status, created_at, message,
        buyer_name, buyer_email, buyer_phone, company_name
      `).eq("status","AVAILABLE").gte("created_at",new Date(Date.now()-30*24*60*60*1e3).toISOString());r!=null&&r.auto_lead_filter,e.budget_min&&(u=u.gte("budget",e.budget_min)),e.budget_max&&(u=u.lte("budget",e.budget_max)),e.search&&(u=u.ilike("product_name",`%${e.search}%`));const y=e.page||1,c=e.limit||20,h=(y-1)*c;u=u.range(h,h+c-1);const{data:S,error:g,count:w}=await u;if(g)throw g;return{data:S||[],quota:a,preferences:r,subscription:d,pagination:{page:y,limit:c,total:w}}},getLeadSummary:async e=>{const{data:t,error:r}=await i.from("leads").select(`
        id, title, product_name, budget, quantity, location,
        created_at, company_name
      `).eq("id",e).single();if(r)throw r;return t},purchaseLead:async e=>{const t=await m.auth.me();if(!(t!=null&&t.id))throw new Error("Vendor not found");console.log("[TRACE] Starting purchaseLead for vendor:",t.id);const{data:r,error:a}=await i.from("leads").select("*").eq("id",e).single();if(a)throw a;if(r.status!=="AVAILABLE")throw new Error("Lead no longer available");const{data:s}=await i.from("lead_purchases").select("id").eq("vendor_id",t.id).eq("lead_id",e).maybeSingle();if(s)throw new Error("You already purchased this lead");console.log("[TRACE] Querying subscriptions for vendor:",t.id);const{data:n,error:d}=await i.from("vendor_plan_subscriptions").select("*").eq("vendor_id",t.id);console.log("[TRACE] All subscriptions query result:",{error:d,count:n==null?void 0:n.length});let l=null;n&&n.length>0&&(l=n.find(w=>w.status==="ACTIVE"),console.log("[TRACE] Found ACTIVE subscription:",{exists:!!l,subData:l}));let o=null;if(l&&l.plan_id){const{data:w}=await i.from("vendor_plans").select("*").eq("id",l.plan_id).maybeSingle();o={...l,plan:w},console.log("[TRACE] Plan fetched:",{planExists:!!w,planName:w==null?void 0:w.name})}else o=l,console.log("[TRACE] No ACTIVE subscription found or missing plan_id");if(console.log("[DEBUG] Subscription check:",{vendor_id:t.id,subscription_exists:!!o,subscription_status:o==null?void 0:o.status,subscription_end_date:o==null?void 0:o.end_date,subscription_plan_id:o==null?void 0:o.plan_id,plan_exists:!!(o!=null&&o.plan),plan_data:o==null?void 0:o.plan,is_subscription_null:o===null,is_subscription_undefined:o===void 0,is_active_result:v(o)}),!v(o))throw console.error("[ERROR] Subscription check failed:",{subscription:o,vendor_id:t.id,subscription_status:o==null?void 0:o.status,subscription_end_date:o==null?void 0:o.end_date}),new Error("No active subscription plan. Please subscribe to purchase leads.");const _=o.plan,f=(_==null?void 0:_.daily_limit)||0,u=(_==null?void 0:_.weekly_limit)||0,y=(_==null?void 0:_.yearly_limit)||0;let{data:c}=await i.from("vendor_lead_quota").select("*").eq("vendor_id",t.id).maybeSingle();if(c)c&&(c=await q(t.id,c));else{const{data:w,error:p}=await i.from("vendor_lead_quota").insert([{vendor_id:t.id,plan_id:o.plan_id,daily_used:0,weekly_used:0,yearly_used:0,daily_reset_at:new Date().toISOString(),weekly_reset_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();p?console.error("Failed to create quota:",p):c=w}if(c){if(f>0&&c.daily_used>=f)throw new Error(`Daily lead limit (${f}) reached`);if(u>0&&c.weekly_used>=u)throw new Error(`Weekly lead limit (${u}) reached`);if(y>0&&c.yearly_used>=y)throw new Error(`Yearly lead limit (${y}) reached`)}const h=50,{data:S,error:g}=await i.from("lead_purchases").insert([{vendor_id:t.id,lead_id:e,amount:h,payment_status:"COMPLETED",purchase_date:new Date().toISOString()}]).select().single();if(g)throw g;return await i.from("leads").update({status:"PURCHASED"}).eq("id",e),c&&await i.from("vendor_lead_quota").update({daily_used:c.daily_used+1,weekly_used:c.weekly_used+1,yearly_used:c.yearly_used+1,updated_at:new Date().toISOString()}).eq("vendor_id",t.id),S},getPurchasedLeadDetails:async e=>{const t=await m.auth.me();if(!(t!=null&&t.id))throw new Error("Vendor not found");const{data:r,error:a}=await i.from("lead_purchases").select("*").eq("vendor_id",t.id).eq("lead_id",e).maybeSingle();if(a)throw a;if(!r)throw new Error("You have not purchased this lead");const{data:s,error:n}=await i.from("leads").select("*").eq("id",e).single();if(n)throw n;const{data:d}=await i.from("lead_contacts").select("*").eq("vendor_id",t.id).eq("lead_id",e).order("contact_date",{ascending:!1});return{lead:s,purchase:r,contacts:d||[],buyer:{name:s.buyer_name,email:s.buyer_email,phone:s.buyer_phone,company:s.company_name}}},logContact:async(e,t,r="")=>{const a=await m.auth.me();if(!(a!=null&&a.id))throw new Error("Vendor not found");const{data:s}=await i.from("lead_purchases").select("id").eq("vendor_id",a.id).eq("lead_id",e).maybeSingle();if(!s)throw new Error("You have not purchased this lead");const{data:n,error:d}=await i.from("lead_contacts").insert([{vendor_id:a.id,lead_id:e,contact_type:t,status:"PENDING",notes:r,contact_date:new Date().toISOString(),created_at:new Date().toISOString()}]).select().single();if(d)throw d;return n},updateContactStatus:async(e,t,r="")=>{const{data:a,error:s}=await i.from("lead_contacts").update({status:t,notes:r,contact_date:new Date().toISOString()}).eq("id",e).select().single();if(s)throw s;return a},getContactHistory:async e=>{const{data:t,error:r}=await i.from("lead_contacts").select("*").eq("lead_id",e).order("contact_date",{ascending:!1});if(r)throw r;return t||[]},getPurchasedLeads:async(e={})=>{const t=await m.auth.me();if(!(t!=null&&t.id))throw new Error("Vendor not found");let r=i.from("lead_purchases").select(`
        id, lead_id, purchase_date, amount,
        leads (
          id, title, product_name, budget, location,
          buyer_name, buyer_email, company_name
        )
      `).eq("vendor_id",t.id);e.status&&(r=r.eq("payment_status",e.status)),e.sort_by==="recent"?r=r.order("purchase_date",{ascending:!1}):e.sort_by==="oldest"&&(r=r.order("purchase_date",{ascending:!0}));const a=e.page||1,s=e.limit||20,n=(a-1)*s;r=r.range(n,n+s-1);const{data:d,error:l,count:o}=await r;if(l)throw l;return{data:d||[],pagination:{page:a,limit:s,total:o}}},getLeadWithContactSummary:async e=>{const t=await m.auth.me();if(!(t!=null&&t.id))throw new Error("Vendor not found");const{data:r}=await i.from("leads").select("*").eq("id",e).single(),{data:a}=await i.from("lead_contacts").select("*").eq("vendor_id",t.id).eq("lead_id",e),s=a&&a.length>0?a[0]:null;return{lead:r,totalContacts:(a==null?void 0:a.length)||0,lastContact:s,contactSummary:{calls:(a==null?void 0:a.filter(n=>n.contact_type==="CALL").length)||0,whatsapp:(a==null?void 0:a.filter(n=>n.contact_type==="WHATSAPP").length)||0,emails:(a==null?void 0:a.filter(n=>n.contact_type==="EMAIL").length)||0,converted:(a==null?void 0:a.filter(n=>n.status==="CONVERTED").length)||0}}},getLeadStats:async()=>{const e=await m.auth.me();if(!(e!=null&&e.id))throw new Error("Vendor not found");const t=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()).toISOString(),a=new Date(t.getTime()-7*24*60*60*1e3).toISOString(),s=new Date(t.getTime()-365*24*60*60*1e3).toISOString(),{count:n}=await i.from("lead_purchases").select("*",{count:"exact",head:!0}).eq("vendor_id",e.id).gte("purchase_date",r),{count:d}=await i.from("lead_purchases").select("*",{count:"exact",head:!0}).eq("vendor_id",e.id).gte("purchase_date",a),{count:l}=await i.from("lead_purchases").select("*",{count:"exact",head:!0}).eq("vendor_id",e.id).gte("purchase_date",s),{count:o,data:_}=await i.from("lead_purchases").select("amount",{count:"exact"}).eq("vendor_id",e.id),{count:f}=await i.from("proposals").select("*",{count:"exact",head:!0}).eq("vendor_id",e.id).eq("status","SENT"),{count:u}=await i.from("lead_contacts").select("*",{count:"exact",head:!0}).eq("vendor_id",e.id),{count:y}=await i.from("lead_contacts").select("*",{count:"exact",head:!0}).eq("vendor_id",e.id).eq("status","CONVERTED"),c=(_||[]).reduce((S,g)=>S+(g.amount||0),0),{data:h}=await i.from("vendor_lead_quota").select("*").eq("vendor_id",e.id).maybeSingle();return{daily:n||0,weekly:d||0,yearly:l||0,direct:f||0,totalPurchased:o||0,totalAmount:c||0,totalContacted:u||0,converted:y||0,conversionRate:o?((y||0)/o*100).toFixed(2):0,quota:h||null}}};export{A as leadsMarketplaceApi};
